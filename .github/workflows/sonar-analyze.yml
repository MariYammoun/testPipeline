name: sonarqube snalysis

on:
  workflow_call:
    inputs:
      app_version:
        required: true
        type: string

jobs:
  sonarqube-analysis:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: set up vm max map count
        run: sudo sysctl -w vm.max_map_count=262144

      - name: start sonarqube docker
        run: |
          docker run -d \
            --name sonarqube \
            -p 9000:9000 \
            sonarqube:community

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Wait for SonarQube to be ready
        run: |
          echo "attente du d√©marrage de sonarqube "
    
          timeout 300s bash -c 'until $(curl --output /dev/null --silent --head --fail http://localhost:9000/api/system/status); do printf "."; sleep 5; done'
          echo -e "\nsonarqube is ready"

      - name: build and analyze with sonar
        run: |
          mvn -B verify sonar:sonar \
            -Dsonar.host.url=http://localhost:9000 \
            -Dsonar.login=admin \
            -Dsonar.password=admin \
            -Dsonar.projectKey=${{ vars.SONAR_PROJECT_KEY }} \
            -Dsonar.projectVersion=${{ inputs.app_version }} \
            -Dsonar.qualitygate.wait=true